<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Arma Reforger — Management Panel</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#c8a84b">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Arma Panel">
<link rel="apple-touch-icon" href="/static/icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0a0c0f;
    --surface:   #111418;
    --surface2:  #161b22;
    --border:    #1e2530;
    --accent:    #c8a84b;
    --accent2:   #e8c96a;
    --text:      #d4cfc6;
    --muted:     #5a6070;
    --online:    #4caf7d;
    --offline:   #d64c4c;
    --warn:      #e0913a;
    --cpu-color: #4c9fd6;
    --ram-color: #c8a84b;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(200,168,75,0.02) 1px, transparent 1px),
      linear-gradient(90deg, rgba(200,168,75,0.02) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .layout {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 24px 60px;
  }

  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
    animation: fadeDown 0.4s ease both;
  }

  .header-left .tag {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 6px;
  }

  .header-left h1 {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 38px;
    letter-spacing: 0.06em;
    color: #fff;
    line-height: 1;
  }

  .header-left h1 span { color: var(--accent); }

  .btn-logout {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    padding: 8px 16px;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
  }
  .btn-logout:hover { border-color: var(--accent); color: var(--accent); }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 22px 26px;
    position: relative;
    margin-bottom: 14px;
    animation: fadeUp 0.4s ease both;
  }

  .card.clip {
    clip-path: polygon(0 0, calc(100% - 24px) 0, 100% 24px, 100% 100%, 0 100%);
  }

  .card-corner {
    position: absolute;
    top: 0; right: 0;
    width: 24px; height: 24px;
    background: var(--accent);
    clip-path: polygon(100% 0, 0 0, 100% 100%);
  }

  .card-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
  }

  /* Status row */
  .status-row {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }

  .status-indicator { display: flex; align-items: center; gap: 10px; }

  .dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
    position: relative;
  }
  .dot.online  { background: var(--online); box-shadow: 0 0 10px var(--online); }
  .dot.offline { background: var(--offline); }
  .dot.loading { background: var(--warn); animation: pulse 1s infinite; }
  .dot.online::after {
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    background: var(--online);
    opacity: 0.25;
    animation: ping 1.5s ease-out infinite;
  }

  @keyframes ping   { 0% { transform: scale(1); opacity: 0.25; } 100% { transform: scale(2.5); opacity: 0; } }
  @keyframes pulse  { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  .status-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 20px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .status-text.online  { color: var(--online); }
  .status-text.offline { color: var(--offline); }
  .status-text.loading { color: var(--warn); }

  .divider-v { width: 1px; height: 32px; background: var(--border); flex-shrink: 0; }

  .stat-item { display: flex; flex-direction: column; gap: 3px; }
  .stat-item .label {
    font-size: 10px; font-weight: 600; letter-spacing: 0.25em;
    text-transform: uppercase; color: var(--muted);
  }
  .stat-item .value {
    font-family: 'Barlow Condensed', sans-serif; font-weight: 700;
    font-size: 17px; letter-spacing: 0.04em; color: #fff;
  }

  /* Controls */
  .controls-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
    margin-bottom: 14px;
    animation: fadeUp 0.4s ease 0.05s both;
  }

  .ctrl-btn {
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 15px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    padding: 18px 16px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .ctrl-btn::before {
    content: ''; position: absolute;
    bottom: 0; left: 0; right: 0; height: 2px;
    transform: scaleX(0); transition: transform 0.2s;
  }
  .ctrl-btn:hover::before { transform: scaleX(1); }
  .ctrl-btn:active { transform: scale(0.97); }
  .ctrl-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
  .ctrl-btn.start::before { background: var(--online); }
  .ctrl-btn.start:hover:not(:disabled) { border-color: var(--online); color: var(--online); }
  .ctrl-btn.stop::before  { background: var(--offline); }
  .ctrl-btn.stop:hover:not(:disabled)  { border-color: var(--offline); color: var(--offline); }
  .ctrl-btn.reset::before { background: var(--warn); }
  .ctrl-btn.reset:hover:not(:disabled) { border-color: var(--warn); color: var(--warn); }
  .ctrl-icon { font-size: 22px; line-height: 1; }

  /* Charts row */
  .charts-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-bottom: 14px;
    animation: fadeUp 0.4s ease 0.1s both;
  }

  .chart-card { background: var(--surface); border: 1px solid var(--border); padding: 18px 20px; }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .chart-title {
    font-size: 10px; font-weight: 600; letter-spacing: 0.3em;
    text-transform: uppercase; color: var(--muted);
  }

  .chart-value {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size: 22px; letter-spacing: 0.05em;
  }

  .chart-value.cpu  { color: var(--cpu-color); }
  .chart-value.ram  { color: var(--ram-color); }

  .chart-sub {
    font-size: 11px; color: var(--muted); margin-top: 2px; text-align: right;
  }

  .chart-wrap { position: relative; height: 80px; }

  /* Config */
  .config-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .field-group { display: flex; flex-direction: column; gap: 7px; }
  .field-group label {
    font-size: 10px; font-weight: 600; letter-spacing: 0.25em;
    text-transform: uppercase; color: var(--muted);
  }
  .field-group input,
  .field-group select {
    background: var(--bg); border: 1px solid var(--border);
    color: var(--text); font-family: 'Barlow', sans-serif;
    font-size: 14px; padding: 10px 14px; outline: none;
    transition: border-color 0.2s; width: 100%;
  }
  .field-group input:focus,
  .field-group select:focus { border-color: var(--accent); }
  .field-group select option { background: var(--surface); color: var(--text); }

  .btn-save {
    margin-top: 14px;
    background: var(--accent); border: none; color: #0a0c0f;
    font-family: 'Barlow Condensed', sans-serif; font-weight: 700;
    font-size: 13px; letter-spacing: 0.2em; text-transform: uppercase;
    padding: 12px 28px; cursor: pointer;
    clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 0 100%);
    transition: background 0.2s;
  }
  .btn-save:hover { background: var(--accent2); }
  .btn-save:disabled { opacity: 0.4; cursor: not-allowed; }

  .restart-notice {
    display: none; margin-top: 10px;
    font-size: 12px; color: var(--warn); letter-spacing: 0.05em;
  }
  .restart-notice.visible { display: block; }

  /* Logs */
  .log-viewer-card {
    background: var(--surface);
    border: 1px solid var(--border);
    animation: fadeUp 0.4s ease 0.2s both;
  }

  .log-viewer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
  }

  .log-viewer-title {
    font-size: 10px; font-weight: 600; letter-spacing: 0.3em;
    text-transform: uppercase; color: var(--muted);
    display: flex; align-items: center; gap: 8px;
  }

  .log-live-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--online);
    box-shadow: 0 0 6px var(--online);
    animation: pulse 1.5s infinite;
  }

  .log-live-dot.off { background: var(--muted); box-shadow: none; animation: none; }

  .btn-clear-log {
    background: transparent; border: 1px solid var(--border);
    color: var(--muted); font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase;
    padding: 5px 12px; cursor: pointer; transition: all 0.2s;
  }
  .btn-clear-log:hover { border-color: var(--accent); color: var(--accent); }

  #log-output {
    font-family: 'Roboto Mono', monospace;
    font-size: 11px;
    line-height: 1.6;
    color: #7a8899;
    background: #0d1117;
    padding: 14px 20px;
    height: 320px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
  }

  #log-output::-webkit-scrollbar { width: 6px; }
  #log-output::-webkit-scrollbar-track { background: #0d1117; }
  #log-output::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .log-line { display: block; padding: 1px 0; }
  .log-line.err  { color: #d64c4c; }
  .log-line.warn { color: #c8a84b; }
  .log-line.ok   { color: #4caf7d; }
  .log-line.sep  { color: #3a4455; }

  /* Bottom log */
  .op-log {
    background: var(--surface); border: 1px solid var(--border);
    padding: 12px 18px; margin-top: 14px;
    animation: fadeUp 0.4s ease 0.25s both;
  }
  .op-log .log-label {
    font-size: 10px; font-weight: 600; letter-spacing: 0.25em;
    text-transform: uppercase; color: var(--muted); margin-bottom: 5px;
  }
  .log-entry { font-size: 13px; color: var(--text); opacity: 0.8; }
  .log-entry.ok    { color: var(--online); }
  .log-entry.error { color: var(--offline); }
  .log-entry.info  { color: var(--accent); }

  footer {
    margin-top: 20px; font-size: 11px; letter-spacing: 0.15em;
    color: var(--muted); text-align: right;
    animation: fadeUp 0.4s ease 0.3s both;
  }
  #refresh-timer { color: var(--accent); font-weight: 600; }

  @keyframes fadeUp   { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<div class="layout">

  <header>
    <div class="header-left">
      <div class="tag">&#9632; Server Management Panel</div>
      <h1>ARMA <span>REFORGER</span></h1>
    </div>
    <button class="btn-logout" onclick="doLogout()">Logout ↗</button>
  </header>

  <!-- Status -->
  <div class="card clip">
    <div class="card-corner"></div>
    <div class="card-label">Server Status</div>
    <div class="status-row">
      <div class="status-indicator">
        <div class="dot loading" id="dot"></div>
        <div class="status-text loading" id="status-text">ŁADOWANIE...</div>
      </div>
      <div class="divider-v"></div>
      <div class="stat-item">
        <div class="label">Name</div>
        <div class="value" id="server-name-display">—</div>
      </div>
      <div class="divider-v"></div>
      <div class="stat-item">
        <div class="label">IP : Port</div>
        <div class="value" id="ip-port-display">—</div>
      </div>
      <div class="divider-v"></div>
      <div class="stat-item">
        <div class="label">Mission</div>
        <div class="value" id="map-name">—</div>
      </div>
      <div class="divider-v"></div>
      <div class="stat-item">
        <div class="label">Uptime</div>
        <div class="value" id="uptime-display">—</div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls-grid">
    <button class="ctrl-btn start" id="btn-start" onclick="serverAction('start')" disabled>
      <span class="ctrl-icon">▶</span>START
    </button>
    <button class="ctrl-btn stop" id="btn-stop" onclick="serverAction('stop')" disabled>
      <span class="ctrl-icon">■</span>STOP
    </button>
    <button class="ctrl-btn reset" id="btn-reset" onclick="serverAction('restart')" disabled>
      <span class="ctrl-icon">↺</span>RESTART
    </button>
  </div>

  <!-- Charts -->
  <div class="charts-row">
    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title">CPU — System</div>
          <div class="chart-sub" id="proc-cpu-sub">Arma: —%</div>
        </div>
        <div>
          <div class="chart-value cpu" id="cpu-val">—%</div>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="chart-cpu"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title">RAM — System</div>
          <div class="chart-sub" id="proc-ram-sub">Arma: — MB</div>
        </div>
        <div>
          <div class="chart-value ram" id="ram-val">—%</div>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="chart-ram"></canvas></div>
    </div>
  </div>

  <!-- Config -->
  <div class="card" style="animation-delay:0.15s">
    <div class="card-label">Server Configuration</div>
    <div class="config-grid">
      <div class="field-group">
        <label for="input-name">Name serwera</label>
        <input type="text" id="input-name" placeholder="np. LEM Arma" maxlength="64" />
      </div>
      <div class="field-group">
        <label for="input-mission">Scenario / Mission</label>
        <select id="input-mission"></select>
      </div>
      <div class="field-group">
        <label for="input-password">Game password (puste = brak hasła)</label>
        <input type="text" id="input-password" placeholder="Zostaw puste aby usunąć hasło" maxlength="64" />
      </div>
      <div class="field-group">
        <label for="input-password-admin">Admin password</label>
        <input type="text" id="input-password-admin" placeholder="Hasło admina" maxlength="64" />
      </div>
    </div>
    <button class="btn-save" id="btn-save" onclick="saveConfig()">Save changes</button>
    <div class="restart-notice" id="restart-notice">⚠ Zmiany zostaną zastosowane po restarcie serwera</div>
  </div>

  <!-- Mods -->
  <div class="card" style="animation-delay:0.18s">
    <div class="card-label">Server Mods</div>

    <!-- Lista aktywnych modów -->
    <div id="mods-list" style="margin-bottom:16px;display:flex;flex-direction:column;gap:8px;">
      <div style="color:var(--muted);font-size:13px">Loading mods...</div>
    </div>

    <!-- Formularz dodawania -->
    <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:4px;">
      <div style="font-size:10px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Add new mod</div>
      <div class="config-grid">
        <div class="field-group">
          <label for="mod-id">Mod ID <span style="color:var(--offline)">*</span></label>
          <input type="text" id="mod-id" placeholder="e.g. 595F2BF2F44836FB" maxlength="64" />
        </div>
        <div class="field-group">
          <label for="mod-name">Name moda <span style="color:var(--offline)">*</span></label>
          <input type="text" id="mod-name" placeholder="e.g. RHS - Status Quo" maxlength="128" />
        </div>
        <div class="field-group">
          <label for="mod-version">Version (optional)</label>
          <input type="text" id="mod-version" placeholder="e.g. 0.14.4795" maxlength="32" />
        </div>
      </div>
      <button class="btn-save" onclick="addMod()" id="btn-add-mod">Add mod</button>
      <div class="restart-notice" id="mods-restart-notice">⚠ Mod changes will be applied after server restart</div>
    </div>
  </div>

  <!-- Live Logs -->
  <div class="log-viewer-card">
    <div class="log-viewer-header">
      <div class="log-viewer-title">
        <div class="log-live-dot off" id="log-live-dot"></div>
        Server logs — live
      </div>
      <button class="btn-clear-log" onclick="clearLog()">Clear</button>
    </div>
    <div id="log-output"></div>
  </div>

  <!-- Op log -->
  <div class="op-log">
    <div class="log-label">Last operation</div>
    <div class="log-entry info" id="log-msg">Oczekiwanie na dane serwera...</div>
  </div>

  <footer>
    Refresh in <span id="refresh-timer">10</span>s &nbsp;|&nbsp; Panel v3.0
  </footer>

</div>

<script>
// ─── Charts setup ────────────────────────────────────────────────────────────
const MAX_POINTS = 60;

function makeChartData(color) {
  return {
    labels: Array(MAX_POINTS).fill(''),
    datasets: [{
      data: Array(MAX_POINTS).fill(null),
      borderColor: color,
      backgroundColor: color + '18',
      borderWidth: 1.5,
      pointRadius: 0,
      fill: true,
      tension: 0.4,
    }]
  };
}

const chartOpts = (max) => ({
  responsive: true,
  maintainAspectRatio: false,
  animation: false,
  plugins: { legend: { display: false }, tooltip: { enabled: false } },
  scales: {
    x: { display: false },
    y: {
      display: true,
      min: 0, max: max,
      grid: { color: '#1e253022', drawBorder: false },
      ticks: {
        color: '#5a6070', font: { size: 9 }, maxTicksLimit: 3,
        callback: v => v + '%'
      }
    }
  }
});

const cpuChart = new Chart(document.getElementById('chart-cpu'), {
  type: 'line',
  data: makeChartData('#4c9fd6'),
  options: chartOpts(100)
});

const ramChart = new Chart(document.getElementById('chart-ram'), {
  type: 'line',
  data: makeChartData('#c8a84b'),
  options: chartOpts(100)
});

function pushChart(chart, value) {
  chart.data.datasets[0].data.push(value);
  if (chart.data.datasets[0].data.length > MAX_POINTS)
    chart.data.datasets[0].data.shift();
  chart.update('none');
}

// ─── Metrics polling ─────────────────────────────────────────────────────────
async function fetchMetrics() {
  try {
    const r = await fetch('/api/metrics');
    if (r.status === 401) { window.location.href = '/login'; return; }
    const d = await r.json();

    const ramPct = d.ram_total > 0 ? Math.round(d.ram_used / d.ram_total * 100) : 0;

    document.getElementById('cpu-val').textContent = (d.cpu ?? 0).toFixed(1) + '%';
    document.getElementById('ram-val').textContent = ramPct + '%';
    document.getElementById('proc-cpu-sub').textContent = 'Arma: ' + (d.running ? (d.cpu ?? 0).toFixed(1) + '%' : '—%');
    document.getElementById('proc-ram-sub').textContent = 'Arma: ' + (d.running ? (d.ram_process ?? 0) + ' MB / ' + d.ram_total + ' MB' : '— MB');

    pushChart(cpuChart, d.cpu ?? 0);
    pushChart(ramChart, ramPct);
  } catch(e) {}
}

setInterval(fetchMetrics, 3000);
fetchMetrics();

// ─── SSE Log stream ───────────────────────────────────────────────────────────
let evtSource = null;

function colorLine(line) {
  const l = line.toLowerCase();
  if (l.includes('(e):') || l.includes('error'))  return 'err';
  if (l.includes('(w):') || l.includes('warning')) return 'warn';
  if (l.includes('online game') || l.includes('server registered')) return 'ok';
  if (line.startsWith('[---'))  return 'sep';
  return '';
}

function appendLog(text) {
  const el = document.getElementById('log-output');
  const span = document.createElement('span');
  span.className = 'log-line ' + colorLine(text);
  span.textContent = text;
  el.appendChild(span);
  el.appendChild(document.createTextNode('\n'));
  // Auto-scroll tylko jeśli użytkownik jest blisko dołu
  if (el.scrollHeight - el.scrollTop < el.clientHeight + 120) {
    el.scrollTop = el.scrollHeight;
  }
  // Limit linii w DOM
  const lines = el.querySelectorAll('.log-line');
  if (lines.length > 800) lines[0].remove();
}

function clearLog() {
  document.getElementById('log-output').innerHTML = '';
}

function startLogStream() {
  if (evtSource) evtSource.close();

  // Pobierz ostatnie 80 linii od razu
  fetchLogs(80);

  // Następnie odpytuj co 2 sekundy po nowe linie
  evtSource = setInterval(() => fetchLogs(30), 2000);
  document.getElementById('log-live-dot').classList.remove('off');
}

let lastLogLine = '';

async function fetchLogs(count) {
  try {
    const r = await fetch(`/api/logs?lines=${count}`);
    if (!r.ok) return;
    const d = await r.json();
    if (!d.lines || d.lines.length === 0) return;

    const el = document.getElementById('log-output');
    const lastNew = d.lines[d.lines.length - 1];

    // Przy pierwszym załadowaniu wyczyść i wstaw wszystko
    if (lastLogLine === '') {
      el.innerHTML = '';
      d.lines.forEach(line => appendLog(line));
      lastLogLine = lastNew;
      return;
    }

    // Przy kolejnych odpytaniach — dodaj tylko linie które są nowe
    if (lastNew === lastLogLine) return;

    const idx = d.lines.lastIndexOf(lastLogLine);
    const newLines = idx >= 0 ? d.lines.slice(idx + 1) : d.lines;
    newLines.forEach(line => appendLog(line));
    lastLogLine = lastNew;
  } catch(e) {}
}

startLogStream();

// ─── Status polling ───────────────────────────────────────────────────────────
let refreshInterval = null;
let countdown = 10;
let busy = false;

async function fetchStatus() {
  try {
    const r = await fetch('/api/status');
    if (r.status === 401) { window.location.href = '/login'; return; }
    const d = await r.json();
    updateUI(d);
  } catch(e) {
    setLog('Connection error', 'error');
  }
}

function updateUI(d) {
  const dot = document.getElementById('dot');
  const txt = document.getElementById('status-text');
  dot.className = 'dot ' + (d.running ? 'online' : 'offline');
  txt.className = 'status-text ' + (d.running ? 'online' : 'offline');
  txt.textContent = d.running ? 'ONLINE' : 'OFFLINE';

  document.getElementById('server-name-display').textContent = d.server_name || '—';
  document.getElementById('ip-port-display').textContent = (d.ip && d.port) ? d.ip + ':' + d.port : '—';
  document.getElementById('map-name').textContent = d.map || '—';
  document.getElementById('uptime-display').textContent = d.running ? (d.uptime || '—') : '—';

  if (!busy) {
    document.getElementById('btn-start').disabled = d.running;
    document.getElementById('btn-stop').disabled  = !d.running;
    document.getElementById('btn-reset').disabled = false;
  }

  const nameInput = document.getElementById('input-name');
  if (document.activeElement !== nameInput) nameInput.value = d.server_name || '';

  const pwdInput = document.getElementById('input-password');
  if (document.activeElement !== pwdInput) pwdInput.value = d.password || '';

  const pwdAdminInput = document.getElementById('input-password-admin');
  if (document.activeElement !== pwdAdminInput) pwdAdminInput.value = d.password_admin || '';

  const sel = document.getElementById('input-mission');
  if (sel.options.length === 0 && d.missions) {
    d.missions.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.id; opt.textContent = m.name;
      sel.appendChild(opt);
    });
  }
  if (d.scenario_id) sel.value = d.scenario_id;

  // Render listy modów
  renderMods(d.mods || []);
}

function renderMods(mods) {
  const container = document.getElementById('mods-list');
  if (mods.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);font-size:13px;font-style:italic">Brak zainstalowanych modów</div>';
    return;
  }
  container.innerHTML = '';
  mods.forEach(mod => {
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;background:var(--bg);border:1px solid var(--border)';
    row.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:3px;min-width:0">
        <div style="font-family:\'Barlow Condensed\',sans-serif;font-weight:700;font-size:15px;color:#fff;letter-spacing:0.04em">${escHtml(mod.name)}</div>
        <div style="display:flex;gap:12px;align-items:center">
          <span style="font-size:11px;color:var(--muted);font-family:\'JetBrains Mono\',monospace">${escHtml(mod.modId)}</span>
          ${mod.version ? `<span style="font-size:11px;color:var(--accent);letter-spacing:0.05em">v${escHtml(mod.version)}</span>` : ''}
        </div>
      </div>
      <button onclick="removeMod('${escHtml(mod.modId)}')" style="
        background:transparent;border:1px solid var(--border);color:var(--muted);
        font-family:\'Barlow Condensed\',sans-serif;font-size:11px;letter-spacing:0.15em;
        text-transform:uppercase;padding:5px 12px;cursor:pointer;flex-shrink:0;
        transition:all 0.2s;white-space:nowrap
      " onmouseover="this.style.borderColor='var(--offline)';this.style.color='var(--offline)'"
         onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">
        Remove ✕
      </button>`;
    container.appendChild(row);
  });
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function addMod() {
  const modId   = document.getElementById('mod-id').value.trim();
  const modName = document.getElementById('mod-name').value.trim();
  const modVer  = document.getElementById('mod-version').value.trim();
  if (!modId)   { setLog('Mod ID jest wymagany', 'error'); return; }
  if (!modName) { setLog('Name moda jest wymagana', 'error'); return; }
  document.getElementById('btn-add-mod').disabled = true;
  setLog('Dodawanie moda...', 'info');
  try {
    const r = await fetch('/api/mods/add', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ modId, name: modName, version: modVer })
    });
    const d = await r.json();
    if (d.ok) {
      setLog(`Mod "${modName}" dodany`, 'ok');
      document.getElementById('mod-id').value = '';
      document.getElementById('mod-name').value = '';
      document.getElementById('mod-version').value = '';
      document.getElementById('mods-restart-notice').classList.toggle('visible', d.restart_required);
      await fetchStatus();
    } else {
      setLog('Błąd: ' + (d.error || 'nieznany'), 'error');
    }
  } catch(e) { setLog('Błąd połączenia', 'error'); }
  document.getElementById('btn-add-mod').disabled = false;
}

async function removeMod(modId) {
  if (!confirm('Usunąć ten mod z konfiguracji?')) return;
  setLog('Usuwanie moda...', 'info');
  try {
    const r = await fetch('/api/mods/remove', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ modId })
    });
    const d = await r.json();
    if (d.ok) {
      setLog('Mod usunięty', 'ok');
      document.getElementById('mods-restart-notice').classList.toggle('visible', d.restart_required);
      await fetchStatus();
    } else {
      setLog('Błąd: ' + (d.error || 'nieznany'), 'error');
    }
  } catch(e) { setLog('Błąd połączenia', 'error'); }
}

function setLog(msg, type = 'info') {
  const el = document.getElementById('log-msg');
  el.className = 'log-entry ' + type;
  const ts = new Date().toLocaleTimeString('pl-PL');
  el.textContent = '[' + ts + '] ' + msg;
}

function setBusy(state) {
  busy = state;
  ['btn-start','btn-stop','btn-reset','btn-save'].forEach(id => {
    document.getElementById(id).disabled = state;
  });
}

async function serverAction(action) {
  const labels = { start: 'Uruchamianie serwera...', stop: 'Zatrzymywanie serwera...', restart: 'Restartowanie serwera...' };
  setBusy(true);
  setLog(labels[action], 'info');
  try {
    const r = await fetch('/api/' + action, { method: 'POST' });
    if (r.status === 401) { window.location.href = '/login'; return; }
    const d = await r.json();
    if (d.ok) {
      const success = { start: 'Serwer uruchomiony', stop: 'Serwer zatrzymany', restart: 'Serwer zrestartowany' };
      setLog(success[action], 'ok');
      await new Promise(res => setTimeout(res, 1500));
      await fetchStatus();
    } else {
      setLog('Błąd: ' + (d.error || 'nieznany'), 'error');
    }
  } catch(e) { setLog('Błąd połączenia', 'error'); }
  setBusy(false);
}

async function saveConfig() {
  const name     = document.getElementById('input-name').value.trim();
  const scenario = document.getElementById('input-mission').value;
  const password = document.getElementById('input-password').value;
  const pwdAdmin = document.getElementById('input-password-admin').value.trim();

  if (!name)     { setLog('Name serwera nie może być pusta', 'error'); return; }
  if (!pwdAdmin) { setLog('Admin password nie może być puste', 'error'); return; }

  setBusy(true);
  setLog('Zapisywanie konfiguracji...', 'info');
  try {
    const r = await fetch('/api/config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ server_name: name, scenario_id: scenario, password, password_admin: pwdAdmin })
    });
    if (r.status === 401) { window.location.href = '/login'; return; }
    const d = await r.json();
    if (d.ok) {
      setLog('Konfiguracja zapisana', 'ok');
      document.getElementById('restart-notice').classList.toggle('visible', !!d.restart_required);
      await fetchStatus();
    } else {
      setLog('Błąd zapisu: ' + (d.error || 'nieznany'), 'error');
    }
  } catch(e) { setLog('Błąd połączenia', 'error'); }
  setBusy(false);
}

async function doLogout() {
  await fetch('/logout', { method: 'POST' });
  window.location.href = '/login';
}

function startCountdown() {
  countdown = 10;
  document.getElementById('refresh-timer').textContent = countdown;
  clearInterval(refreshInterval);
  refreshInterval = setInterval(() => {
    countdown--;
    document.getElementById('refresh-timer').textContent = countdown;
    if (countdown <= 0) { fetchStatus(); countdown = 10; }
  }, 1000);
}

fetchStatus().then(startCountdown);

// PWA — rejestracja service workera
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .catch(err => console.log('SW error:', err));
  });
}
</script>
</body>
</html>
